<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ArXiv filter</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
	
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
	
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
	
    <!-- https://davidstutz.github.io/bootstrap-multiselect/#getting-started -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/css/bootstrap-multiselect.min.css" integrity="sha512-fZNmykQ6RlCyzGl9he+ScLrlU0LWeaR6MO/Kq9lelfXOw54O63gizFMSD5fVgZvU1YfDIc6mxom5n60qJ1nCrQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/js/bootstrap-multiselect.min.js" integrity="sha512-lxQ4VnKKW7foGFV6L9zlSe+6QppP9B2t+tMMaV4s4iqAv4iHIyXED7O+fke1VeLNaRdoVkVt8Hw/jmZ+XocsXQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<script src="//unpkg.com/alpinejs" defer></script>

	<!-- Had lots of trouble getting a reasonable multi-select button to work, and Alpine was not good for it. -->
	<!-- Makes me think I maybe should have gone with Vue: -->
	<!-- https://vue-multiselect.js.org/                   -->

	<script> MathJax = { tex: {	inlineMath: [['$', '$'], ['\\(', '\\)']] } }; </script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

	<style>
		.spacedlist li {
			margin-bottom: 10px;  /* Space elements out in the list at the bottom */
		}
	</style>

  </head>
  <body>
    <div class="container">

	<br/>
	<br/>

	
    <div id="signin-div" style="display: none">
        <button id="signin-button" class="btn btn-primary btn-sm">Sign in</button>
		<br/>
		<br/>
    </div>
    <div id="signout-div" style="display: none" x-data="{showoptions: false}">
		<button x-on:click="showoptions = !showoptions" class="btn btn-primary btn-sm">Toggle options</button>
        <button id="signout-button" class="btn btn-secondary btn-sm">Sign out</button>
		Signed in as <span id="user-name"></span>.
		<br/>
		<br/>
		<div class="container-sm" style="background-color: gainsboro; padding: 2em; border-radius: 1em;" x-show="showoptions" x-transition>
			<div class="row">
				<div class="col-sm">
					<h2>Select arXiv categories to track</h2>
					<p>You may select any number (between one and three should do).</p>
					<!-- style="width: auto;" -->
					<!-- https://github.com/alpinejs/alpine/issues/495  x-model="$store.main.categories" -->
					<select id="selectcategories" multiple="multiple" class="form-select">
						<template x-for="(description, category) in {
							'astro-ph.CO': 'Cosmology and Nongalactic Astrophysics',
							'astro-ph.EP': 'Earth and Planetary Astrophysics',
							'astro-ph.GA': 'Astrophysics of Galaxies',
							'astro-ph.HE': 'High Energy Astrophysical Phenomena',
							'astro-ph.IM': 'Instrumentation and Methods for Astrophysics',
							'astro-ph.SR': 'Solar and Stellar Astrophysics',
							'cond-mat.dis-nn': 'Disordered Systems and Neural Networks',
							'cond-mat.mes-hall': 'Mesoscale and Nanoscale Physics',
							'cond-mat.mtrl-sci': 'Materials Science',
							'cond-mat.other': 'Other Condensed Matter',
							'cond-mat.quant-gas': 'Quantum Gases',
							'cond-mat.soft': 'Soft Condensed Matter',
							'cond-mat.stat-mech': 'Statistical Mechanics',
							'cond-mat.str-el': 'Strongly Correlated Electrons',
							'cond-mat.supr-con': 'Superconductivity',
							'cs.AI': 'Artificial Intelligence',
							'cs.AR': 'Hardware Architecture',
							'cs.CC': 'Computational Complexity',
							'cs.CE': 'Computational Engineering, Finance, and Science',
							'cs.CG': 'Computational Geometry',
							'cs.CL': 'Computation and Language',
							'cs.CR': 'Cryptography and Security',
							'cs.CV': 'Computer Vision and Pattern Recognition',
							'cs.CY': 'Computers and Society',
							'cs.DB': 'Databases',
							'cs.DC': 'Distributed, Parallel, and Cluster Computing',
							'cs.DL': 'Digital Libraries',
							'cs.DM': 'Discrete Mathematics',
							'cs.DS': 'Data Structures and Algorithms',
							'cs.ET': 'Emerging Technologies',
							'cs.FL': 'Formal Languages and Automata Theory',
							'cs.GL': 'General Literature',
							'cs.GR': 'Graphics',
							'cs.GT': 'Computer Science and Game Theory',
							'cs.HC': 'Human-Computer Interaction',
							'cs.IR': 'Information Retrieval',
							'cs.IT': 'Information Theory',
							'cs.LG': 'Learning',
							'cs.LO': 'Logic in Computer Science',
							'cs.MA': 'Multiagent Systems',
							'cs.MM': 'Multimedia',
							'cs.MS': 'Mathematical Software',
							'cs.NA': 'Numerical Analysis',
							'cs.NE': 'Neural and Evolutionary Computing',
							'cs.NI': 'Networking and Internet Architecture',
							'cs.OH': 'Other Computer Science',
							'cs.OS': 'Operating Systems',
							'cs.PF': 'Performance',
							'cs.PL': 'Programming Languages',
							'cs.RO': 'Robotics',
							'cs.SC': 'Symbolic Computation',
							'cs.SD': 'Sound',
							'cs.SE': 'Software Engineering',
							'cs.SI': 'Social and Information Networks',
							'cs.SY': 'Systems and Control',
							'econ.EM': 'Econometrics',
							'econ.GN': 'General Economics',
							'econ.TH': 'Theoretical Economics',
							'eess.AS': 'Audio and Speech Processing',
							'eess.IV': 'Image and Video Processing',
							'eess.SP': 'Signal Processing',
							'eess.SY': 'Systems and Control',
							'gr-qc': 'General Relativity and Quantum Cosmology',
							'hep-ex': 'High Energy Physics - Experiment',
							'hep-lat': 'High Energy Physics - Lattice',
							'hep-ph': 'High Energy Physics - Phenomenology',
							'hep-th': 'High Energy Physics - Theory',
							'math-ph': 'Mathematical Physics',
							'math.AC': 'Commutative Algebra',
							'math.AG': 'Algebraic Geometry',
							'math.AP': 'Analysis of PDEs',
							'math.AT': 'Algebraic Topology',
							'math.CA': 'Classical Analysis and ODEs',
							'math.CO': 'Combinatorics',
							'math.CT': 'Category Theory',
							'math.CV': 'Complex Variables',
							'math.DG': 'Differential Geometry',
							'math.DS': 'Dynamical Systems',
							'math.FA': 'Functional Analysis',
							'math.GM': 'General Mathematics',
							'math.GN': 'General Topology',
							'math.GR': 'Group Theory',
							'math.GT': 'Geometric Topology',
							'math.HO': 'History and Overview',
							'math.IT': 'Information Theory',
							'math.KT': 'K-Theory and Homology',
							'math.LO': 'Logic',
							'math.MG': 'Metric Geometry',
							'math.MP': 'Mathematical Physics',
							'math.NA': 'Numerical Analysis',
							'math.NT': 'Number Theory',
							'math.OA': 'Operator Algebras',
							'math.OC': 'Optimization and Control',
							'math.PR': 'Probability',
							'math.QA': 'Quantum Algebra',
							'math.RA': 'Rings and Algebras',
							'math.RT': 'Representation Theory',
							'math.SG': 'Symplectic Geometry',
							'math.SP': 'Spectral Theory',
							'math.ST': 'Statistics Theory',
							'nlin.AO': 'Adaptation and Self-Organizing Systems',
							'nlin.CD': 'Chaotic Dynamics',
							'nlin.CG': 'Cellular Automata and Lattice Gases',
							'nlin.PS': 'Pattern Formation and Solitons',
							'nlin.SI': 'Exactly Solvable and Integrable Systems',
							'nucl-ex': 'Nuclear Experiment',
							'nucl-th': 'Nuclear Theory',
							'physics.acc-ph': 'Accelerator Physics',
							'physics.ao-ph': 'Atmospheric and Oceanic Physics',
							'physics.app-ph': 'Applied Physics',
							'physics.atm-clus': 'Atomic and Molecular Clusters',
							'physics.atom-ph': 'Atomic Physics',
							'physics.bio-ph': 'Biological Physics',
							'physics.chem-ph': 'Chemical Physics',
							'physics.class-ph': 'Classical Physics',
							'physics.comp-ph': 'Computational Physics',
							'physics.data-an': 'Data Analysis, Statistics and Probability',
							'physics.ed-ph': 'Physics Education',
							'physics.flu-dyn': 'Fluid Dynamics',
							'physics.gen-ph': 'General Physics',
							'physics.geo-ph': 'Geophysics',
							'physics.hist-ph': 'History and Philosophy of Physics',
							'physics.ins-det': 'Instrumentation and Detectors',
							'physics.med-ph': 'Medical Physics',
							'physics.optics': 'Optics',
							'physics.plasm-ph': 'Plasma Physics',
							'physics.pop-ph': 'Popular Physics',
							'physics.soc-ph': 'Physics and Society',
							'physics.space-ph': 'Space Physics',
							'q-bio.BM': 'Biomolecules',
							'q-bio.CB': 'Cell Behavior',
							'q-bio.GN': 'Genomics',
							'q-bio.MN': 'Molecular Networks',
							'q-bio.NC': 'Neurons and Cognition',
							'q-bio.OT': 'Other',
							'q-bio.PE': 'Populations and Evolution',
							'q-bio.QM': 'Quantitative Methods',
							'q-bio.SC': 'Subcellular Processes',
							'q-bio.TO': 'Tissues and Organs',
							'q-fin.CP': 'Computational Finance',
							'q-fin.EC': 'Economics',
							'q-fin.GN': 'General Finance',
							'q-fin.MF': 'Mathematical Finance',
							'q-fin.PM': 'Portfolio Management',
							'q-fin.PR': 'Pricing of Securities',
							'q-fin.RM': 'Risk Management',
							'q-fin.ST': 'Statistical Finance',
							'q-fin.TR': 'Trading and Microstructure',
							'quant-ph': 'Quantum Physics',
							'stat.AP': 'Applications',
							'stat.CO': 'Computation',
							'stat.ME': 'Methodology',
							'stat.ML': 'Machine Learning',
							'stat.OT': 'Other Statistics',
							'stat.TH': 'Theory'
						}">
							<!-- :selected="$store.main.categories.some(cat => cat === category)" -->
							<option :value="category" x-text="category + ' (' + description + ')'"></option>
						</template>
					</select>
					<br/>
					<br/>
				</div>
			</div>
			<div class="row">
				<div class="col-sm">
					<h2>List excluded words</h2>
					<p>If a paper's title contains any of the lines in the box below, it is filtered out. Case insensitive; whitespace counts.</p>
					<!-- style="width: auto;" -->
					<textarea id="exclusion-textarea" x-model="$store.main.exclusions" rows="7" class="form-control"></textarea>
					<br/>
				</div>
			</div>
			
			<div class="row">
				<div class="col-sm">
					<h2>Enable "Share to Slack" button (optional)</h2>
					<p>To do so, provide a <a href="https://api.slack.com/messaging/webhooks" target="_blank">webhook url</a> to your favorite channel.</p>
					<input type="text" id="slackurl" x-model="$store.main.slackurl" class="form-control" style="width: auto;"></input>
					<br/>
				</div>
			</div>

			<button id="deleteuser-button" class="btn btn-secondary btn-sm">Delete user</button>

		</div>
	</div>
	
	<p>
		Sign in and select arXiv lists in the options.
		The latest daily announcements appear below, with some filtered out based on keywords.
		Click the rows of papers that look interesting: their abstracts will appear at the bottom of the page, with buttons to share (clipboard; slack if enabled).
		<ul id="listdigests"></ul>
	</p>
	
	<table>
		<tr>
			<td># new papers shown:&nbsp;&nbsp;&nbsp;&nbsp;</td>
			<td x-data="{get count() { return $store.main.articlesNew.length; }}" x-text="count"></td>
		</tr>
		<tr>
			<td># updated papers shown:&nbsp;&nbsp;&nbsp;&nbsp;</td>
			<td x-data="{get count() { return $store.main.articlesUpdated.length; }}" x-text="count"></td>
		</tr>
		<tr>
			<td># papers filtered out:&nbsp;&nbsp;&nbsp;&nbsp;</td>
			<td x-data="{get count() { return $store.main.articlesHidden.length; }}" x-text="count"></td>
		</tr>
	</table>
	
	<br/>
  
    <h1>New papers (<span x-data="{get count() { return $store.main.articlesNew.length; }}" x-text="count"></span>)</h1>
	
	<table class="table table-striped" x-data="">
		<thead>
			<tr>
				<th scope="col">#</th>
				<th scope="col">Title</th>
				<th scope="col">Authors</th>
			</tr>
		</thead>
		<tbody>
			<template x-for="article in $store.main.articlesNew" :key="article.id">
				<tr x-on:click="$store.main.toggleSelection(article.id)" :class="article.selected ? 'table-info' : ''">
					<td x-text="article.id"></td>
					<td><a target="_blank" :href="article.link" x-text="article.title"></a></td>
					<td x-text="article.authors"></td>
				</tr>
			</template>
		</tbody>
	</table>
	
	<br/>
  
    <h1>Updated papers (<span x-data="{get count() { return $store.main.articlesUpdated.length; }}" x-text="count"></span>)</h1>
	
	<table class="table table-striped" x-data="">
		<thead>
			<tr>
				<th scope="col">#</th>
				<th scope="col">v</th>
				<th scope="col">Title</th>
				<th scope="col">Authors</th>
			</tr>
		</thead>
		<tbody>
			<template x-for="article in $store.main.articlesUpdated" :key="article.id">
				<tr x-on:click="$store.main.toggleSelection(article.id)" :class="article.selected ? 'table-info' : ''">
					<td x-text="article.id"></td>
					<td x-text="article.version"></td>
					<td><a target="_blank" :href="article.link" x-text="article.title"></a></td>
					<td x-text="article.authors"></td>
				</tr>
			</template>
		</tbody>
	</table>
	
	<br/>

	<!-- https://help.socialintents.com/article/148-how-to-find-your-slack-team-id-and-slack-channel-id -->
	<!-- #general on optimepfl: https://app.slack.com/client/T01B6UR5KME/C01AABV7X70 -->
	<!-- https://api.slack.com/messaging/webhooks -->
	<!-- https://api.slack.com/reference/deep-linking -->
	<!--
	Best on mobile: <a href="slack://channel?team=T01B6UR5KME&id=C01AABV7X70" target="_blank">open #general slack channel with slack://</a><br/>
	Not sure about this one: <a href="https://slack.com/app_redirect?channel=general" target="_blank">open #general slack channel with slack.com/app_redirect</a><br/>
	Best on desktop: <a href="https://app.slack.com/client/T01B6UR5KME/C01AABV7X70" target="_blank">open #general slack channel with direct url</a>
	<br/>
	<br/>
	-->
  
    <h1>Selected papers</h1>

	<!-- https://stackoverflow.com/questions/2409836/how-to-set-cursor-style-to-pointer-for-links-without-hrefs -->
	<ul class="spacedlist" x-data="">
		<template x-for="article in $store.main.articlesSelected" :key="article.id">
			<li>
				<a target="_blank" :href="article.link"
					x-data="{ get title() { return escapeHtml(article.title) + ((article.updated) ? ' (updated, v' + article.version + ')' : '') } }"
					x-text="title"></a>
				<a href="" style="text-decoration: none" title="Copy to clipboard"
					x-on:click.prevent="toClipboard(article.id, $el)">&#x1F4CB;</a>
				<a href="" style="text-decoration: none" title="Send to slack"
					x-on:click.prevent="toSlack(article.id, $el)"
					x-show="$store.main.slackurl.length > 4"><img src="slack.png" width="16px" style="padding-bottom: 4px;"/></a>
					<!--
					x-data="{get showSlack() {{return document.getElementById('slackurl').value.trim().length > 0;}}}"
					x-show="showSlack"><img src="slack.png" width="16px" style="padding-bottom: 4px;"/></a>
					-->
				<br/><i x-text="article.authors"></i>
				<br/><span x-html="article.summary"></span>
			</li>
		</template>
	</ul>
	
	<br/>
	<br/>
	
	<script>
		
		const escapeHtml = (unsafe) => {
			return unsafe.replaceAll('&', '&amp;').replaceAll('<', '&lt;')
			             .replaceAll('>', '&gt;').replaceAll('"', '&quot;')
			             .replaceAll("'", '&#039;').replaceAll("/", '&#x2F;')
			             .replaceAll("`", '&#x60;').replaceAll("=", '&#x3D;');
		}
		

		// ChatGPT proposed this after some interaction, to replace the commented code below.
		// Had to fix it manually, but not bad.
		const latexAccentsToHtml = (latexstring) => {
    return latexstring
        .replaceAll(/\\'([aeiouAEIOU])/g, (match, p1) => {
            const accents = {
                'a': 'á',
                'e': 'é',
                'i': 'í',
                'o': 'ó',
                'u': 'ú',
                'A': 'Á',
                'E': 'É',
                'I': 'Í',
                'O': 'Ó',
                'U': 'Ú'
            };
            return accents[p1] || match;
        })
        .replaceAll(/\\`([aeiouAEIOU])/g, (match, p1) => {
            const accents = {
                'a': 'à',
                'e': 'è',
                'i': 'ì',
                'o': 'ò',
                'u': 'ù',
                'A': 'À',
                'E': 'È',
                'I': 'Ì',
                'O': 'Ò',
                'U': 'Ù'
            };
            return accents[p1] || match;
        })
        .replaceAll(/\\~([anoANO])/g, (match, p1) => {
            const accents = {
                'a': 'ã',
                'n': 'ñ',
                'o': 'õ',
                'A': 'Ã',
                'N': 'Ñ',
                'O': 'Õ'
            };
            return accents[p1] || match;
        })
        .replaceAll(/\\c{([csCS])}/g, (match, p1) => {
            const accents = {
                'c': 'ç',
                's': 'ş',
                'C': 'Ç',
                'S': 'Ş'
            };
            return accents[p1] || match;
        })
        .replaceAll(/\{\\ss\}/g, 'ß')
        .replaceAll(/\\"([aeiouyAEIOUY])/g, (match, p1) => {
            const accents = {
                'a': 'ä',
                'e': 'ë',
                'i': 'ï',
                'o': 'ö',
                'u': 'ü',
                'y': 'ÿ',
                'A': 'Ä',
                'E': 'Ë',
                'I': 'Ï',
                'O': 'Ö',
                'U': 'Ü',
                'Y': 'Ÿ'
            };
            return accents[p1] || match;
        })
        .replaceAll(/\\\^([aeioAEIO])/g, (match, p1) => {
            const accents = {
                'a': 'â',
                'e': 'ê',
                'i': 'î',
                'o': 'ô',
                'A': 'Â',
                'E': 'Ê',
                'I': 'Î',
                'O': 'Ô'
            };
            return accents[p1] || match;
        })
        .replaceAll(/\\v{([cszeCSZE])}/g, (match, p1) => {
            const accents = {
                'c': 'č',
                's': 'š',
                'z': 'ž',
                'e': 'ě',
                'C': 'Č',
                'S': 'Š',
                'Z': 'Ž',
                'E': 'Ě'
            };
            return accents[p1] || match;
        })
      	.replaceAll(/\\r{u}/g, 'ů')
      	.replaceAll(/\\r{U}/g, 'Ů');
		};

		// const latexAccentsToHtml = (latexstring) => { // Todo: replace with HTMl codes and complete the list
		// 	return latexstring.replaceAll('\\\'e', 'é').replaceAll('\\`e', 'è')
		// 	                  .replaceAll('\\\'E', 'É').replaceAll('\\`E', 'È')
		// 	                  .replaceAll('\\\'a', 'á').replaceAll('\\`a', 'à')
		// 	                  .replaceAll('\\\'A', 'Á').replaceAll('\\`A', 'À')
		// 	                  .replaceAll('\\\'o', 'ó').replaceAll('\\`o', 'ò')
		// 	                  .replaceAll('\\\'O', 'Ó').replaceAll('\\`O', 'Ò')
		// 	                  .replaceAll('\\\'u', 'ú').replaceAll('\\`u', 'ù')
		// 	                  .replaceAll('\\\'U', 'Ú').replaceAll('\\`U', 'Ù')
		// 	                  .replaceAll('\\\'i', 'í').replaceAll('\\`i', 'ì')
		// 	                  .replaceAll('\\\'I', 'Í').replaceAll('\\`I', 'Ì')
		// 	                  .replaceAll('\\c{c}', 'ç').replaceAll('\\\'c', 'ć')
		// 	                  .replaceAll('{\\ss}', 'ß')
		// 	                  .replaceAll('\\"e', 'ë').replaceAll('\\"E', 'Ë')
		// 	                  .replaceAll('\\"o', 'ö').replaceAll('\\"O', 'Ö')
		// 	                  .replaceAll('\\^i', 'î').replaceAll('\\^I', 'Î')
		// 	                  .replaceAll('\\^o', 'ô').replaceAll('\\^O', 'Ô')
		// 	                  .replaceAll('\\^a', 'â').replaceAll('\\^A', 'Â')
		// 	                  .replaceAll('\\"u', 'ü').replaceAll('\\"U', 'Ü')
		// 	                  .replaceAll('\\~n', 'ñ').replaceAll('\\~N', 'Ñ')
		// 	                  .replaceAll('\\v{s}', 'š').replaceAll('\\v{S}', 'Š');
		// }

		// arXiv digest surrounds each author name with an <a> tag we don't need.
		// Likewise, abstracts have html, e.g., <p> tags.
		// This bit of code removes the html parts.
		const extractTextFromHtml = (text) => {
			return $("<div>").html(text).text().trim();
		}
	
		const filterOut = (article) => {
			// We want to hide this paper if the title contains a word from the exclusions list.
			var exclusion = document.getElementById('exclusion-textarea').value.split('\n');
			// If the title contains any word from the list (case insensitive), return true.
			var lctitle = article.title.toLowerCase();
			return exclusion.some(word => word.trim().length >= 1 && lctitle.includes(word.toLowerCase()));
		}

		const getArticle = (id) => {
			return Alpine.store('main').digest.find(article => article.id === id);
		}

		async function toClipboard(id, $button) {
			var article = getArticle(id);
			var text = escapeHtml(article.title) + 
						"\r\n" + article.authors +
						"\r\n" + article.link +
						((article.updated) ? " (updated, v" + article.version + ")" : "") +
						"\r\n" +
						"\r\n" + extractTextFromHtml(article.summary);
			await navigator.clipboard.writeText(text);	
			var oldtext = $button.innerHTML;
			$button.innerHTML = "&#x2713;";
			setTimeout(() => {$button.innerHTML = oldtext;}, 1000);
		}

		const toSlack = (id, $button) => {
			var article = getArticle(id);
			var text = escapeHtml(article.title) +
						"\n_" + article.authors + "_" +
						"\n" + article.link +
						((article.updated) ? " (updated, v" + article.version + ")" : "") +
						// "\n" +
						"\n>" + extractTextFromHtml(article.summary);
			
			var url = document.getElementById('slackurl').value;
			// https://api.slack.com/reference/surfaces/formatting
			// https://api.slack.com/messaging/composing/layouts
			var data = {type: "mrkdwn", text: text};
			$.post(url, JSON.stringify(data))
					.done(() => {
						var oldtext = $button.innerHTML;
						$button.innerHTML = "&#x2713;";
						setTimeout(() => {$button.innerHTML = oldtext;}, 10000);
					})
					.fail(function(jqxhr, settings, ex) {
						var oldtext = $button.innerHTML;
						$button.innerHTML = "&#10060;";
						setTimeout(() => {$button.innerHTML = oldtext;}, 1000);
						console.log(jqxhr);
						console.log(settings);
						console.log(ex);
					});
		}

		const fetchCategory = (category) => {

			// We fetch articles listed in the following rss feed:
			// "https://export.arxiv.org/rss/" + category
			// However, since that feed does not set CORS headers properly,
			// we instead issue the query to a worker on cloudflare.
			// That worker fetches the data from arxiv and add the
			// proper headers before passing the response along.
			// https://developers.cloudflare.com/workers/examples/alter-headers/
			// https://developers.cloudflare.com/workers/examples/cors-header-proxy/
			// https://css-tricks.com/proxying-third-party-javascript-as-first-party-javascript-and-the-potential-effect-on-analytics/
			var rssbaseurl = "https://arxiv-digest-fetcher.nicolasboumal.workers.dev/?category=";
			// var rssbaseurl = "https://rss.arxiv.org/rss/";

			$.get(rssbaseurl + category, function(data) {

				var $xml = $(data);
				//console.log($xml);
				var catlongname = $xml.find("channel").find("title")[0].innerHTML;
				var date = new Date($xml.find("channel").find("pubDate")[0].innerHTML);
				//$("#listdigests").append('<li><a target="_blank" href="https://arxiv.org/list/' + category + '/recent">' + catlongname + '</a>, ' + date.toDateString() + '</li>');
				$("#listdigests").append('<li><a target="_blank" href="' + rssbaseurl + category + '">' + catlongname + '</a>, ' + date.toDateString() + '</li>');


				$xml.find("channel").find("item").each(function() {

					var $this = $(this);
					var article = {
						id: $this.find("link").text().split('/').slice(-1)[0], // could use .pop() instead of .slice(-1)[0]
						version: Number($this.find("guid").text().split('v').slice(-1)[0]),
						title: $this.find("title").text(),
						authors: latexAccentsToHtml(extractTextFromHtml($this.find("dc\\:creator").text().split("\n").map(s => s.trim()).filter(s => s !== '').join(', '))),   // "[nodeName=dc:creator]", https://stackoverflow.com/questions/853740/how-to-use-jquery-for-xml-parsing-with-namespaces
						maincategory: $this.find("category")[0].innerHTML, // this is the official primary category of the article
						incategories: [category], // keep track of all loaded categories where this article came up -- does this still work?
						updated: ($this.find("arxiv\\:announce_type").text().includes('replace')),
						crosslisted: ($this.find("arxiv\\:announce_type").text().includes('cross')),
						link: $this.find("link").text(),
						summary: $this.find("description").text().replaceAll("\n", " ").split("Abstract: ").slice(-1)[0],
						hide: false,
						selected: false,
						date: date  // redundant, but it's convenient to have it here for syncing with db
					};

					// console.log($this);
					// console.log(article);
					
					// Try to find this article in the list we have already built so far.
					var index = Alpine.store('main').digest.findIndex(existing_article => existing_article.id === article.id);
					if(index == -1) {
						// The article is new: determine whether it should be hidden or not,
						article.hide = filterOut(article);
						// and add it to the collection.
						Alpine.store('main').digest.push(article);
					}
					else {
						// The article is already in the list: record the fact that we saw it in this category too.
						if(!Alpine.store('main').digest[index].incategories.some(cat => cat === category)) {
							Alpine.store('main').digest[index].incategories.push(category);
						}
					}

				}); // end for each item in xml

				// Get the list of papers already selected, as stored on DB, and update Alpine list.
				// TODO: This should use the date here..
				Alpine.store('main').getSelectedArticlesOfTheDay(date);

				// MathJax.typeset(); // This likely executes too early, but "await Alpine.$nextTick();" doesn't work
				// Added a timeout to execute it somewhat later... let's see.
				Alpine.nextTick(() => { setTimeout(() => MathJax.typeset(), 1000); });

			}); // end get url

			// TODO handle fails?
		};

		document.addEventListener('alpine:init', () => {

			// The digest array is meant to contain the full list of papers in today's arXiv digest, for selected categories.
			// Each element is an article with fields:
			//  id, version, title, authors, category, updated, crosslisted, link, summary, hide, selected

			Alpine.store('main', {
				digest: [],
				categories: [],
				slackurl: '',
				exclusions: '',
				get articlesNew() {
					return this.digest.filter(article => !article.hide && !article.updated);
				},
				get articlesUpdated() {
					return this.digest.filter(article => !article.hide && article.updated);
				},
				get articlesSelected() {
					return this.digest.filter(article => article.selected);
				},
				get articlesHidden() {
					return this.digest.filter(article => article.hide);
				},
				toggleSelection(id) {
					var index = this.digest.findIndex(article => article.id === id);
					this.digest[index].selected = !this.digest[index].selected;
					this.articleSelectionChange(id);
					Alpine.nextTick(() => { MathJax.typeset(); });
				}
			});

		}); // end Alpine init

	</script>

	</div>


      <!-- Insert this script at the bottom of the HTML, but before you use any Firebase services -->
	  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.9.4/firebase-app.js';

        // If you enabled Analytics in your project, add the Firebase SDK for Google Analytics
        // import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.9.4/firebase-analytics.js';

        // Add Firebase products that you want to use
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, deleteUser, reauthenticateWithCredential } from 'https://www.gstatic.com/firebasejs/9.9.4/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.9.4/firebase-firestore.js';
        // Removed: addDoc, updateDoc, query, orderBy
        // TODO: there is a "lite" version for Firestore

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAbF2a_FSYjnN66_pQtxd8-cC9ba5wU9S8",
            authDomain: "arxiv-digest.firebaseapp.com",
            databaseURL: "https://arxiv-digest.firebaseio.com",
            projectId: "arxiv-digest",
            storageBucket: "arxiv-digest.appspot.com",
            messagingSenderId: "403410606061",
            appId: "1:403410606061:web:563052dd9b6e2caf1b39e4",
            //measurementId: "G-CDYH5HPQ81"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore();

        async function signIn() {
            // TODO: change it so we do not request the user's profile picture nor language preferences.
            var provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);   // On mobile, should prefer signInWithRedirect, https://firebase.google.com/docs/auth/web/google-signin
        }
        function signOutUser() {
            signOut(auth);
        }

        function userIsSignedIn() {
            return !!auth.currentUser;
        }

		function reflectExclusionsChange() {
			Alpine.store('main').digest.forEach((article, index) => Alpine.store('main').digest[index].hide = filterOut(article));
		}

        function reflectUserData() {
            if(userIsSignedIn()) {
                const uid = auth.currentUser.uid;
                const userdoc = doc(db, "users/" + uid);
                getDoc(userdoc).then((obj) => {
                    if(obj.exists()) {   
                        const data = obj.data();
                        if("slackurl" in data) {
                    		Alpine.store('main').slackurl = data.slackurl;
                        }
                        if("exclusions" in data) {
                        	Alpine.store('main').exclusions = data.exclusions;
							// document.getElementById("exclusion-textarea").value = data.exclusions;
							reflectExclusionsChange();
                        }
						if("categories" in data) {
							Alpine.store('main').categories = data.categories;
							// Alpine.nextTick();
							// Could also "watch" the store array in #selectcategories directly, but careful with infinite loops
							// https://postsrc.com/code-snippets/how-to-watch-alpine-js-store-value
							$('#selectcategories').val(Alpine.store('main').categories).multiselect('refresh');
							selectedCategoriesUpdated();
						}
                    }
                });
            }
            else {
				// Don't force empty categories if not signed in.
                Alpine.store('main').slackurl = "";
                Alpine.store('main').exclusions = "";
            }
        }

        function authStateObserver(user) {
            if(user) {
                reflectUserData();
                var userName = auth.currentUser.displayName;
                document.getElementById("user-name").innerText = userName;
                document.getElementById("signin-div").style.display = "none";
                document.getElementById("signout-div").style.display = "block";
            }
            else {
                document.getElementById("user-name").innerText = "";
                document.getElementById("signin-div").style.display = "block";
                document.getElementById("signout-div").style.display = "none";
            }
        }

        function deleteUserButton() {
            const user = auth.currentUser;
			if(user && $("#deleteuser-button").hasClass("btn-secondary")) {
				$("#deleteuser-button").attr("disabled", "disabled").removeClass("btn-secondary").addClass("btn-warning").text("Just a couple seconds..");
				setTimeout(() => {
					$("#deleteuser-button").removeAttr("disabled").removeClass("btn-warning").addClass("btn-danger").text("Click again to delete (permanent)");
				}, 3000);
				return;
			}
            deleteUser(user).then(() => {
                $("#deleteuser-button").text("That worked.").attr("disabled", "disabled");
				$("#deleteuser-button").removeAttr("disabled").removeClass("btn-danger").addClass("btn-secondary").text("Delete user");
				authStateObserver(user);
            }).catch((error) => {
				$("#deleteuser-button").text("Requires a recent sign in: please sign out, sign in, and try again.");
                console.log("User not deleted. Error:");
                console.log(error);
				// https://firebase.google.com/docs/auth/web/manage-users#re-authenticate_a_user
				// Prompt the user to re-provide their sign-in credentials
				// const credential = promptForCredentials(); // would need to implement this.
				// reauthenticateWithCredential(user, credential).then(() => {
				//		// User re-authenticated.
				//	}).catch((error) => {
				//		// An error ocurred
				//		// ...
				// });
            });
        }

        document.getElementById("signin-button").onclick = signIn;
        document.getElementById("signout-button").onclick = signOutUser;
        document.getElementById("deleteuser-button").onclick = deleteUserButton;
        onAuthStateChanged(auth, authStateObserver);
        authStateObserver(auth.currentUser);

        const slackurlChange = () => {
            if(userIsSignedIn()) {
                const uid = auth.currentUser.uid;
                const userdoc = doc(db, "users/" + uid);
                var data = { slackurl: document.getElementById("slackurl").value };
                setDoc(userdoc, data, {merge: true}); // create the doc if inexistent; update it if existent.
                // TODO: add .then and .catch handlers.
            }
        };

        const exclusionChange = () => {
			reflectExclusionsChange();
            if(userIsSignedIn()) {
                const uid = auth.currentUser.uid;
                const userdoc = doc(db, "users/" + uid);
                var data = { exclusions: document.getElementById("exclusion-textarea").value };
                setDoc(userdoc, data, {merge: true}); // create the doc if inexistent; update it if existent.
                // TODO: add .then and .catch handlers.
            }
        };
		
		const arraysHaveCommonElement = (array1, array2) => {
			return array1.some(x => array2.includes(x));
		};
		const selectedCategoriesUpdated = () => {
			// TODO: Only fetch the ones we didn't already.
			$("#listdigests").html("");
			Alpine.store('main').categories = $('#selectcategories').val();
			Alpine.store('main').categories.forEach(category => fetchCategory(category));
			Alpine.store('main').digest = Alpine.store('main').digest.filter(article => arraysHaveCommonElement(article.incategories, Alpine.store('main').categories));
            if(userIsSignedIn()) {
                const uid = auth.currentUser.uid;
                const userdoc = doc(db, "users/" + uid);
                var data = { categories: Alpine.store('main').categories };
                setDoc(userdoc, data, {merge: true}); // create the doc if inexistent; update it if existent.
                // TODO: add .then and .catch handlers.
            }
		};
		const articleSelectionChange = (id) => {
            if(userIsSignedIn()) {
				const uid = auth.currentUser.uid;
				const date = getArticle(id).date;
				const dateid = date.toISOString().split('T')[0];  // E.g.: '2023-12-31'
				const todayuserdoc = doc(db, "days/" + dateid + "/users/" + uid);
				const listofselectedarticles = Alpine.store('main').digest.filter(article => article.selected).map(article => article.id); // array of selected article IDs
				const data = { selected: listofselectedarticles };
				setDoc(todayuserdoc, data, { merge: true }); // create the doc if inexistent; update it if existent. TODO: add .then and .catch handlers.
            }
		};
		const getSelectedArticlesOfTheDay = (date) => {
            if(userIsSignedIn()) {
				const uid = auth.currentUser.uid;
				const dateid = date.toISOString().split('T')[0];  // E.g.: '2023-12-31'
				const todayuserdoc = doc(db, "days/" + dateid + "/users/" + uid);
                getDoc(todayuserdoc).then((obj) => {
                    if(obj.exists()) {   
                        const data = obj.data();
                        if("selected" in data) {
							const listofselectedarticles = data.selected;
							listofselectedarticles.forEach((id) => {
								const index = Alpine.store('main').digest.findIndex(article => article.id === id);
								Alpine.store('main').digest[index].selected = true;
							});
						}
					}
				});
            }
		};
		Alpine.store('main').articleSelectionChange = articleSelectionChange;
		Alpine.store('main').getSelectedArticlesOfTheDay = getSelectedArticlesOfTheDay;

		/*
        Alpine.store('main').categories.forEach(cat => {
            document.getElementById(cat).onclick = () => { categoryCheckboxClick(cat) };
        });
		*/
		// TODO: maybe instead of binding these manually to "onChange" events,
		// I should add these functions to Alpine.store('main'), so they'd be
		// available to Alpine functions to call themselves.
        document.getElementById("slackurl").onchange = slackurlChange;
        document.getElementById("exclusion-textarea").onchange = exclusionChange;
        document.getElementById("selectcategories").onchange = selectedCategoriesUpdated;


		// Initialize the multiselect plugin.
		// The templates are necessary for Bootstrap 5:
		// https://github.com/davidstutz/bootstrap-multiselect/issues/1230
		$('#selectcategories').multiselect({
			enableFiltering: true,
			maxHeight: 400,
			enableCaseInsensitiveFiltering: true,
			// https://stackoverflow.com/questions/19004466/how-to-change-the-bootstrap-multiselect-label-instead-of-selected-all
			buttonText: function(options, select) {
				var numberOfOptions = $(this).children('option').length;
				if(options.length === 0) {
					const nonSelectedText = 'Select at least one arXiv category';
					return nonSelectedText; // + ' <b class="caret"></b>';
				}
				else {
					const numberDisplayed = 4;
					if(options.length > numberDisplayed) {
						if(options.length === numberOfOptions){
							return ' All arXiv categories selected'; // + ' <b class="caret"></b>'; // This won't happen for us
						}
						const nSelectedText = 'arXiv categories selected';
						return options.length + ' ' + nSelectedText; // + ' <b class="caret"></b>';
					} else {
						let selected = '';
						const displaytype = (options.length <= 1) ? 'label' : 'value';  // choose 'label' or 'value'
						options.each(function() {
							const label = ($(this).attr(displaytype) !== undefined) ?  
															$(this).attr(displaytype) : $(this).html();
							selected += label + ', ';
						});
						return selected.substr(0, selected.length - 2); // + ' <b class="caret"></b>';
					}
				}
			},
			templates: {
				button: '<button type="button" class="multiselect dropdown-toggle btn btn-sm btn-primary" data-bs-toggle="dropdown" aria-expanded="false"><span class="multiselect-selected-text"></span></button>',
			},           
		});

    </script>
	
  </body>
</html>
