<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr" lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
  <!-- Analytics (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z3XP9VMHJ3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-Z3XP9VMHJ3');
  </script>
  <!-- Meta -->
  <title>An introduction to optimization on smooth manifolds</title>
  <meta name="description" content="Resources for book introduction to optimization on smooth manifolds">
  <meta name="author" content="Nicolas Boumal">
  <meta name="keywords"
    content="Optimization on manifolds,Riemannian optimization,Manopt,pdf,book,lectures,exercises,video">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Bootstrap & CSS-->
  <link href="../css/bootstrap.css" rel="stylesheet" media="screen">
  <style type="text/css">
    body {
      padding-top: 10px;
      padding-bottom: 20px;
    }
    div .section {
      display: auto;
    }
    ul {
      list-style: disc;
    }
    .table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
      background-color: blanchedalmond;
    }
    tbody tr th {
      font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif; /* Font for IDs (000, 001, 101, ...) */
    }
    .number {
      font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif; /* Font for IDs (000, 001, 101, ...) */
    }
  </style>
  <style>
    ul.toc.collapsed {
      list-style-type: none;
      font-weight: normal;
    }
    ul.toc.collapsed li ul {
      display: none;
    }
    ul.toc {
      list-style-type: none;
      font-weight: bold;
      padding-left: 0;
    }
    ul.toc li ul {
      list-style-type: none;
      font-weight: normal;
    }
  </style>
  <style>
    title {
      display: block;
      font-weight: bold;
      font-size: 30px;
      margin-top: 24px;
      margin-bottom: 12px;
      box-sizing: border-box;
      color: #333333;
    }

    answer {
      visibility: hidden;
      display: block;
      margin: 10px;
      padding: 10px;
      background-color: lightsteelblue;
    }

    sketch {
      visibility: hidden;
      display: block;
      margin: 10px;
      padding: 10px;
      background-color: lightgoldenrodyellow;
    }

    question {
      display: block;
      margin: 10px;
      padding: 10px;
      background-color: antiquewhite;
    }

    hint {
      display: block;
    }
  </style>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <!-- not sure the javascript below gets anything done at all, since the html is not loaded yet... try it. -->
  <script type="text/javascript">$(".section").hide();</script>

  <!-- https://highlightjs.org/#usage -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/styles/atom-one-dark.min.css"> <!-- default.min.css -->
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/languages/matlab.min.js"></script>
  <style type="text/css">
    .featurelesspre {
      margin: 0;
      padding: 0;
      border-radius: 0;
      border: 0;
      background: none;
    }
    pre code.hljs {
      margin: 10px;
      padding: 10px;
      border-radius: 0;
      border: 0;
    }
  </style>

	<script src="//unpkg.com/alpinejs" defer></script>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-sm-12 col-lg-9">
        <div class="page-header" style="display: block">
          <h1 style="display: block"><small style="font-size: 100%">an introduction to</small><br>Optimization on smooth manifolds</h1>
        </div>
        <ul class="nav nav-tabs nav-justified" role="navigation">
          <li id="li-book"><a href="#book" class="menu" id="tab-book">Book</a></li>
          <li id="li-lectures"><a href="#lectures" class="menu" id="tab-lectures">Lectures</a></li>
          <li id="li-exercises"><a href="#exercises" class="menu" id="tab-exercises">Exercises</a></li>
          <li id="li-software"><a href="#software" class="menu" id="tab-software">Software</a></li>
          <li id="li-more"><a href="#more" class="menu" id="tab-more">More</a></li>
        </ul>
        <br>

        <div class="section" id="section-lectures">
          <div class="media row" align="justify">
            <p>
              I taught Riemannian optimization at EPFL in spring 2023 for the course MATH-512.
              We recorded the lectures, available below.
              A semester runs for 14 weeks.
              Most weeks have a lecture and an exercise session, which each last 90-95 minutes (week 5 had double lectures).
              The students further learned the material by completing two extensive projects.
            </p>
                            
            <p>
              Video links bring you to an external hosting service.
              There, you can change the playback speed of videos (play faster, slower): see controls at the bottom-right of the video panel.
              You can also download the videos.
            </p>

            <p>
              I gratefully acknowledge <a target="_blank" href="https://www.epfl.ch/education/educational-initiatives/cede/">EPFL's CEDE</a> for video post-production!
            </p>
          </div>
          <div class="media row">
            <!-- TABLE ORDERED BY WEEK -->
            <table class="table table-hover" x-data="">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Slides</th>
                  <th scope="col">Title + videos</th>
                </tr>
              </thead>
              <template x-for="(topics, week) in $store.main.weeks">
                <template x-if="week > 0">
                  <tbody>
                    <tr>
                      <th scope="rowgroup" colspan="42">
                        <span x-data="{weekdisp: 'Week ' + week}" x-text="weekdisp"></span>
                        <span style="font-weight: normal; float: right"><a :href="$store.main.exercises_per_week[week]">exercises</a></span>
                      </th>
                    </tr>
                    <template x-for="(topic, order) in topics">
                      <template x-if="topic">
                        <tr>
                          <th scope="row" x-text="topic.id"></th>
                          <td><a target="_blank" title="slides" :href="topic.slides">pdf</a></td>
                          <td>
                            <span x-text="topic.title"></span><br>
                              <template x-for="vid in topic.videos">
                                <template x-if="vid.url">
                                  <li>
                                    <a target="_blank" :href="vid.url" x-data="{vidlink: vid.comments ? vid.comments : 'Video'}" x-text="vidlink"></a>,
                                    <span x-data="{vidtime: vid.duration + ' min'}" x-text="vidtime"></span>
                                    <template x-if="vid.booksections != ''">
                                      <span style="white-space: nowrap; overflow: scroll;" x-data="{sectionstext: '(book &#167;' + vid.booksections.join(', &#167;') + ')'}" x-text="sectionstext"></span>
                                    </template>
                                  </li>
                                </template>
                              </template>
                          </td>
                        </tr>
                      </template>
                    </template>
                  </tbody>
                </template>
              </template>
            </table>
          </div>
        </div>

        <div class="section" id="section-exercises">
          <div class="media row" align="justify">
            <p>
              Exercises and solutions were prepared by Nicolas Boumal, Christopher Criscitiello and Timon Miehling in 2023.
            </p>
            <p>
              Click a <span style="background-color: antiquewhite;">question</span> to display a <span style="background-color: lightgoldenrodyellow;">sketch</span> of the answer if available.
              Click a <span style="background-color: lightgoldenrodyellow;">sketch</span> of the answer to display a detailed <span style="background-color: lightsteelblue;">answer</span> if available.
              If no sketch is available but a detailed answer is, then clicking the question displays the detailed answer.
            </p>
            <!-- General info about how to show / hide answers and their sketches. -->
            <div style="border-radius: 0px; background-color: white; padding: 10px; padding-bottom: 1px; margin: 10px; margin-top: 0px;">
              <p>
                Sketches of answers: <a onclick="$('sketch').slideUp(400);">hide all</a>, <a onclick="$('sketch').slideDown(400);">show all</a>.
                Detailed answers: <a onclick="$('answer').slideUp(400);">hide all</a>, <a onclick="$('answer').slideDown(400);">show all</a>.
              </p>
            </div>
          </div>
          <div class="media row">
            <!-- JQuery adds exercises in this div. -->
            <div id="theexercises"></div>
          </div>
        </div>

        <div class="section" id="section-software">
          <div class="media row">
            Software.
          </div>
        </div>

        <div class="section" id="section-more">
          <div class="media row">
            More.
          </div>
        </div>

        <div class="section" id="section-book">
          <div class="media row">
            <div class="col-lg-3 col-md-3 col-sm-12">
              <div class="media-body"> <img alt="picture"
                    title="An introduction to optimization on smooth manifolds" class="media-object img-rounded"
                    src="../images/BoumalIntroSmoothManifoldsCover.png"
                    style="width:100%; max-width:220px; margin:auto; margin-bottom:8mm; display:block;">
              </div>
              <!--margin: auto; display:block; is to center the image...-->
              <!--width: 192px; height: 250px;-->
            </div>
            <div class="col-lg-9 col-md-9 col-sm-12">
              <div class="media-body" align="justify">
                <p>
                  This book about Riemannian optimization by <a href="https://www.nicolasboumal.net" target="_blank">Nicolas Boumal</a> is published
                  by <a href="https://cambridge.org/9781009166157" target="_blank">Cambridge University Press</a>, 2023.
                <p>
                <p>
                  You can also <a href="IntroOptimManifolds_Boumal_2023.html" target="_blank"
                          title="Download An introduction to optimization on smooth manifolds">download the pre-publication PDF</a> (Feb. 11, 2023).
                </p>
                <p>
                  Chapters 3 and 5 can serve as a standalone introduction to differential and Riemannian geometry,
                  focused on embedded submanifolds of linear spaces, with proofs and an eye towards computability.
                  It then builds from there to cover algorithms and equip the reader for modern research challenges.
                </p>
                <p>
                  Feel free to <a href="mailto:nicolas.boumal@epfl.ch">e-mail me</a> about
                  any mistakes you spot or suspect, be it typos or more serious things.
                  I appreciate your input, always.
                </p>
              </div>
            </div>
            <div class="media-body col-12">
              <div class="media-body hyphenate" align="justify">
                <h4>About the book</h4>
  
                <p>
                Optimization on manifolds is the result of smooth geometry and
                optimization merging into one elegant modern framework.
                This text introduces the differential geometry and Riemannian
                geometry concepts to help students and researchers in applied
                mathematics, computer science and engineering gain a firm
                mathematical grounding to use these tools confidently in their
                research.</p>
                
                <p>
                All definitions and theorems are motivated to build time-tested
                optimization algorithms. Starting from first principles,
                the text goes on to cover current research on topics including
                iteration complexity and geodesic convexity.
                Readers will appreciate the tricks of the trade sprinkled
                throughout the book, to guide research and numerical
                implementations.</p>
  
                <p>
                This book has no prerequisites in geometry or optimization.
                Chapters 3 and 5 can serve as a standalone introduction to
                differential and Riemannian geometry, focused on embedded
                submanifolds of linear spaces, with full proofs and an emphasis on computability.</p>
                <!-- It then builds from there to equip the reader to take on modern research challenges. -->
                
                <p>
                Chapter 8 provides the general theory so that we can build quotient
                manifolds in Chapter 9. The optimization algorithms in Chapters
                4 and 6 apply to the general case, but can already be understood
                after reading Chapters 3 and 5. Chapter 7 details examples of
                submanifolds that come up in practice. Chapter 10 covers more
                advanced Riemannian tools, and Chapter 11 introduces geodesic
                convexity.</p>
                
              </div>
              <div class="media-body hyphenate" align="justify">
                <h4>Additional resources</h4>
  
                <p>
                Lectures (videos + slides) and exercises are gradually uploaded to <a href="more.html" target="_blank">this page</a>.</p>
                
                <p>
                <a href="../papers/IntroOptimManifoldsSlides2020.htm"
                  title="Slides about optimization on manifolds" target="_blank">These
                  slides</a> hold a summary of the basic geometric tools and
                algorithms from Chapters 3 and 5. Here are a <a
                  href="https://www.youtube.com/watch?v=UjaoZE0GBpg&amp;ab_channel=SimonsInstitute"
                  target="_blank">one-hour video</a> and a <a
                  href="https://www.youtube.com/watch?v=lK62DwSIjXA&amp;t=6s&amp;ab_channel=FMGDataDrivenControlSummerSchool"
                  target="_blank">two-hour video</a> introducing the basics of
                differential geometry and Riemannian geometry for optimization
                on smooth manifolds, using <a href="https://simons.berkeley.edu/talks/tbd-337" target="_blank">a variation
                  of the slides linked here</a>.
                These two videos have mostly the same contents.</p>
  
                <p>
                You may also be interested in the Manopt toolboxes (<a href="https://www.manopt.org"
                  target="_blank">Matlab</a>, <a href="https://www.pymanopt.org" target="_blank">Python</a>, <a
                  href="https://www.manoptjl.org" target="_blank">Julia</a>), and in the book <a target="_blank"
                  href="https://press.princeton.edu/absil">Optimization
                  Algorithms on Matrix Manifolds</a> by Absil, Mahony and
                Sepulchre (Princeton University Press, 2008), all freely
                available online.</p>
                
              </div>
              <div class="media-body hyphenate" align="justify">
                <h4>Teaching</h4>
                
                <p>
                As a course, this material is popular with applied mathematicians
                and mathematically inclined engineering students, at the graduate
                and advanced undergraduate level.</p>
  
                <p>
                In a one-semester graduate course of the mathematics department at
                Princeton University in 2019 and 2020 (24 lectures of 80 minutes
                each, two projects, no exercises), I covered much of Chapters
                1&#8211;6 and select parts of Chapter 7 before the midterm
                break, then much of Chapters 8&#8211;9 and select parts of
                Chapters 10&#8211;11 after the break. Those chapters were
                shorter at the time, but it still made for a sustained pace.</p>
                
                <p>
                At EPFL in 2021, I discussed mostly Chapters 1&#8211;8 in 13
                lectures of 90 minutes, plus as many exercise sessions and two
                projects.</p>
  
                <p>
                At EPFL in 2023, the lectures are recorded: see resources above.</p>
                
              </div>
  
              <div class="media-body">
                <h4>How to cite</h4>
                <span style="font-family: monospace;">@Book{boumal2023intromanifolds,<br>
                  &#160; title&#160;&#160;&#160;&#160; = {An
                  introduction to optimization on smooth manifolds},<br>
                  &#160; author&#160;&#160;&#160; = {Boumal,
                  Nicolas},<br>
                  &#160; publisher = {Cambridge University
                  Press},<br>
                  &#160; year&#160;&#160;&#160;&#160;&#160; =
                  {2023},<br>
                  &#160;
                  url&#160;&#160;&#160;&#160;&#160;&#160; =
                  {https://www.nicolasboumal.net/book},<br>
                  &#160;
                  doi&#160;&#160;&#160;&#160;&#160;&#160; =
                  {10.1017/9781009166164}<br>
                  }</span>
              </div>
              <div class="media-body hyphenate" align="justify"><br>
                It is best to reference sections, theorems, equations, etc., as all such objects are numbered identically in the pre-publication PDF available here and in the published version.
                In contrast, page numbers differ.</div>
              <div class="media-body hyphenate" align="justify"><br>
                <h4>Table of contents <span style="font-weight: normal;">(<a onclick="toctoggle()" id="tocbutton">expand/collapse</a>)</span></h4>
              </div>
              <div class="media-body col-12">
                <ul class="toc" id="booktoc">
                  <li>Preface</li>
                  <li>1. Introduction</li>
                  <li>2. Simple examples
                    <ul>
                      <li>2.1 Sensor network localization from directions: an affine subspace</li>
                      <li>2.2 Single extreme eigenvalue or singular value: spheres</li>
                      <li>2.3 Dictionary learning: products of spheres</li>
                      <li>2.4 Principal component analysis: Stiefel and Grassmann</li>
                      <li>2.5 Synchronization of rotations: special orthogonal group</li>
                      <li>2.6 Low-rank matrix completion: fixed-rank manifold</li>
                      <li>2.7 Gaussian mixture models: positive definite matrices</li>
                      <li>2.8 Smooth semidefinite programs</li>
                    </ul>
                  </li>
                  <li>3. Embedded geometry: first order
                    <ul>
                      <li>3.1 Reminders of Euclidean space</li>
                      <li>3.2 Embedded submanifolds of a linear space</li>
                      <li>3.3 Smooth maps on embedded submanifolds</li>
                      <li>3.4 The differential of a smooth map</li>
                      <li>3.5 Vector fields and the tangent bundle</li>
                      <li>3.6 Moving on a manifold: retractions</li>
                      <li>3.7 Riemannian manifolds and submanifolds</li>
                      <li>3.8 Riemannian gradients</li>
                      <li>3.9 Local frames*</li>
                      <li>3.10 Notes and references</li>
                    </ul>
                  </li>
                  <li>4. First-order optimization algorithms
                    <ul>
                      <li>4.1 A first-order Taylor expansion on curves</li>
                      <li>4.2 First-order optimality conditions</li>
                      <li>4.3 Riemannian gradient descent</li>
                      <li>4.4 Regularity conditions and iteration complexity</li>
                      <li>4.5 Backtracking line-search</li>
                      <li>4.6 Local convergence*</li>
                      <li>4.7 Computing gradients*</li>
                      <li>4.8 Numerically checking a gradient*</li>
                      <li>4.9 Notes and references</li>
                    </ul>
                  </li>
                  <li>5. Embedded geometry: second order
                    <ul>
                      <li>5.1 The case for another derivative of vector fields</li>
                      <li>5.2 Another look at differentials of vector fields in linear spaces</li>
                      <li>5.3 Differentiating vector fields on manifolds: connections</li>
                      <li>5.4 Riemannian connections</li>
                      <li>5.5 Riemannian Hessians</li>
                      <li>5.6 Connections as pointwise derivatives*</li>
                      <li>5.7 Differentiating vector fields on curves</li>
                      <li>5.8 Acceleration and geodesics</li>
                      <li>5.9 A second-order Taylor expansion on curves</li>
                      <li>5.10 Second-order retractions</li>
                      <li>5.11 Special case: Riemannian submanifolds*</li>
                      <li>5.12 Special case: metric projection retractions*</li>
                      <li>5.13 Notes and references</li>
                    </ul>
                  </li>
                  <li>6. Second-order optimization algorithms
                    <ul>
                      <li>6.1 Second-order optimality conditions</li>
                      <li>6.2 Riemannian Newton's method</li>
                      <li>6.3 Computing Newton steps: conjugate gradients</li>
                      <li>6.4 Riemannian trust regions</li>
                      <li>6.5 The trust-region subproblem: truncated CG</li>
                      <li>6.6 Local convergence of RTR with tCG*</li>
                      <li>6.7 Simplified assumptions for RTR with tCG*</li>
                      <li>6.8 Numerically checking a Hessian*</li>
                      <li>6.9 Notes and references</li>
                    </ul>
                  </li>
                  <li>7. Embedded submanifolds: examples
                    <ul>
                      <li>7.1 Euclidean spaces as manifolds</li>
                      <li>7.2 The unit sphere in a Euclidean space</li>
                      <li>7.3 The Stiefel manifold: orthonormal matrices</li>
                      <li>7.4 The orthogonal group and rotation matrices</li>
                      <li>7.5 Fixed-rank matrices</li>
                      <li>7.6 The hyperboloid model</li>
                      <li>7.7 Manifolds defined by $h(x) = 0$</li>
                      <li>7.8 Notes and references</li>
                    </ul>
                  </li>
                  <li>8. General manifolds
                    <ul>
                      <li>8.1 A permissive definition</li>
                      <li>8.2 The atlas topology, and a final definition</li>
                      <li>8.3 Embedded submanifolds are manifolds</li>
                      <li>8.4 Tangent vectors and tangent spaces</li>
                      <li>8.5 Differentials of smooth maps</li>
                      <li>8.6 Tangent bundles and vector fields</li>
                      <li>8.7 Retractions and velocity of a curve</li>
                      <li>8.8 Coordinate vector fields as local frames</li>
                      <li>8.9 Riemannian metrics and gradients</li>
                      <li>8.10 Lie brackets as vector fields</li>
                      <li>8.11 Riemannian connections and Hessians</li>
                      <li>8.12 Covariant derivatives and geodesics</li>
                      <li>8.13 Taylor expansions and second-order retractions</li>
                      <li>8.14 Submanifolds embedded in manifolds</li>
                      <li>8.15 Notes and references</li>
                    </ul>
                  </li>
                  <li>9. Quotient manifolds
                    <ul>
                      <li>9.1 A definition and a few facts</li>
                      <li>9.2 Quotient manifolds through group actions</li>
                      <li>9.3 Smooth maps to and from quotient manifolds</li>
                      <li>9.4 Tangent, vertical and horizontal spaces</li>
                      <li>9.5 Vector fields</li>
                      <li>9.6 Retractions</li>
                      <li>9.7 Riemannian quotient manifolds</li>
                      <li>9.8 Gradients</li>
                      <li>9.9 A word about Riemannian gradient descent</li>
                      <li>9.10 Connections</li>
                      <li>9.11 Hessians</li>
                      <li>9.12 A word about Riemannian Newton's method</li>
                      <li>9.13 Total space embedded in a linear space</li>
                      <li>9.14 Horizontal curves and covariant derivatives</li>
                      <li>9.15 Acceleration, geodesics and second-order retractions</li>
                      <li>9.16 Grassmann manifold: summary*</li>
                      <li>9.17 Notes and references</li>
                    </ul>
                  </li>
                  <li>10. Additional tools
                    <ul>
                      <li>10.1 Distance, geodesics and completeness</li>
                      <li>10.2 Exponential and logarithmic maps</li>
                      <li>10.3 Parallel transport</li>
                      <li>10.4 Lipschitz conditions and Taylor expansions</li>
                      <li>10.5 Transporters</li>
                      <li>10.6 Finite difference approximation of the Hessian</li>
                      <li>10.7 Tensor fields and their covariant differentiation</li>
                      <li>10.8 Notes and references</li>
                    </ul>
                  </li>
                  <li>11. Geodesic convexity
                    <ul>
                      <li>11.1 Convex sets and functions in linear spaces</li>
                      <li>11.2 Geodesically convex sets and functions</li>
                      <li>11.3 Alternative definitions of geodesically convex sets*</li>
                      <li>11.4 Differentiable geodesically convex functions</li>
                      <li>11.5 Geodesic strong convexity and Lipschitz continuous gradients</li>
                      <li>11.6 Example: positive reals and geometric programming</li>
                      <li>11.7 Example: positive definite matrices</li>
                      <li>11.8 Notes and references</li>
                    </ul>
                  </li>
                  <li>Bibliography</li>
                </ul>
                <br>
                <br>
              </div>
            </div>
          </div>
        </div>
        <div class="page-footer"><small class="pull-right">Last update: September 9, 2023.</small></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap's javascript -->
  <script type="text/javascript" src="../js/bootstrap.min.js"></script>


  <!-- ALPINE -->
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('main', {
        categories: {},  // categories and topics within
        topics: {},  // all topics brought to a top level, indexed by week
        sortedweeks: [],  // indices for topics, sorted
        weeks: [],  // each week has a number (1..12) and weeks[i] contains an array of topics treated that week, in order
        exercises_per_week: {}
      });
      // Load the data from a JSON file.
      $.ajax({
        url: "topics.json",
        dataType: "json",
        success: function (data) {
          // Go through each category listed in the data.
          for(var category in data) {
            // Check how many visible topics are in this category.
            var ntopics = 0;
            for(var topic in data[category]) {
              var thistopic = data[category][topic];
              thistopic.id = topic;
              if(!thistopic.hasOwnProperty('hide') || !thistopic.hide) {
                Alpine.store('main').topics[thistopic.week] = thistopic;
                ntopics++;
                var weeknumber = Number(Math.floor(thistopic.week));
                var weeksubnumber = Number(Math.round((thistopic.week - weeknumber) * 10));
                if(Alpine.store('main').weeks[weeknumber] === undefined) {
                  Alpine.store('main').weeks[weeknumber] = [];
                }
                Alpine.store('main').weeks[weeknumber][weeksubnumber] = thistopic;
              }
            }
            // Collect only those categories which have at least one visible topic.
            if(ntopics > 0) {  // Object.keys(data[category]).length > 0
              Alpine.store('main').categories[category] = data[category];
            }
          }
          Alpine.store('main').sortedweeks = Object.keys(Alpine.store('main').topics).sort((a, b) => {return Number(a) - Number(b);});
        }
      });
      $.ajax({
        url: "exercises_per_week.json",
        dataType: "json",
        success: function (data) {
          for(var week in data) {
            Alpine.store('main').exercises_per_week[week] = '?list=' + data[week].join(',') + '#exercises';
          }
        }
      });
    }); // end Alpine init
  </script>

  
  <!-- a little bit of scripting for the menu -->
  <script type="text/javascript">
    $("#tab-book").click(function () {
      $(".section").hide();
      $("#section-book").show();
      $("li.active").removeClass('active');
      $("#li-book").addClass('active');
    });
    $("#tab-lectures").click(function () {
      $(".section").hide();
      $("#section-lectures").show();
      $("li.active").removeClass('active');
      $("#li-lectures").addClass('active');
    });
    $("#tab-exercises").click(function () {
      $(".section").hide();
      $("#section-exercises").show();
      $("li.active").removeClass('active');
      $("#li-exercises").addClass('active');
    });
    $("#tab-software").click(function () {
      $(".section").hide();
      $("#section-software").show();
      $("li.active").removeClass('active');
      $("#li-software").addClass('active');
    });
    $("#tab-more").click(function () {
      $(".section").hide();
      $("#section-more").show();
      $("li.active").removeClass('active');
      $("#li-more").addClass('active');
    });
  </script>
  <script type="text/javascript">
    // Merci Matthew!
    function gotoAnchor() {
      var hash = window.location.hash;
      switch (hash) {
        case "#book":
          $("#tab-book").click();
          break;
        case "#lectures":
          $("#tab-lectures").click();
          break;
        case "#exercises":
          $("#tab-exercises").click();
          break;
        case "#software":
          $("#tab-software").click();
          break;
        case "#more":
          $("#tab-more").click();
          break;
        default:
          $("#tab-book").click();
      }
    };
    gotoAnchor();
  </script>

  <!-- Begin script TOC -->
  <script type="text/javascript">
    var toccollapsed = true; // set initial state here
    var toctoggle = function () {
      if (toccollapsed) {
        $("#booktoc").removeClass("collapsed");
        $("#tocbutton").text("collapse");
      }
      else {
        $("#booktoc").addClass("collapsed");
        $("#tocbutton").text("expand");
      }
      toccollapsed = !toccollapsed;
    };
    toccollapsed = !toccollapsed; toctoggle(); // this line sets the TOC in proper beginning state.
  </script>
  <!-- End script TOC -->
  
  <script>
    // This executes once the DOM is ready for JQuery to manipulate it.
    $(function() {

      // This webpage is meant to be accessed via the URL  www.example.com/thisfile.html?list=exoid1,exoid2,exoid3
      const searchParams = new URLSearchParams(window.location.search);
      if(searchParams.has("list")) {

        const exercises = searchParams.get("list").split(",");

        exercises.forEach(exo => {
          var exodiv = $('<div id="' + exo + '"></div>');
          $("#theexercises").append(exodiv);
          $.ajax({
            url: "exercises/" + exo + ".html",
            dataType: "html",
            success: function (data) {

              $('#' + exo).html(data);

              $('#' + exo + ' ' + 'hint').prepend("<em>Hint:</em> ");

              // Had to force the default display of <answer> tag to "block" to avoid it being "inline",
              // because slideToggle remembers the previous style and resets it to that.
              // But don't want the answers to appear initially on the page, so css sets them to be
              // invisible by default, and the next two lines take care of hiding them but with the proper
              // memory inside the slideToggle command.
              $('#' + exo + ' ' + 'answer').slideToggle(0);
              $('#' + exo + ' ' + 'answer').css({'visibility': 'visible'});
              $('#' + exo + ' ' + 'sketch').slideToggle(0);
              $('#' + exo + ' ' + 'sketch').css({'visibility': 'visible'});
              $('#' + exo + ' ' + 'question').on('click', function() { $(this).next('sketch, answer').slideToggle(400); });
              $('#' + exo + ' ' + 'sketch').on('click', function() { $(this).next('answer').slideToggle(400); });

              // Format Latex code
              MathJax.typeset();

              // Format Matlab code
              $('#' + exo + ' ' + 'matlab').each((counter, domobject) => {

                if(!domobject.hasAttribute('href')){  
                  // The code appears as:   <matlab> code here </matlab>
                  // The actual code inside must be extracted,
                  // spurious newlines at the beginning and end must be removed,
                  // and the remaining text must be included in a <pre><code> ... </code><pre> element.
                  // Then, the <code> element must be passed to HighlightJS (not the pre), with the proper language class.
                  // The resulting element is then substituted for the original one in the DOM.
                  $newdomobject = $('<pre class="featurelesspre"></pre>')
                                        .append('<code class="language-matlab">' + $(domobject).text().trim() + '</code>');
                  hljs.highlightElement($newdomobject.get(0).firstChild);
                  $(domobject).replaceWith($newdomobject);
                }
                else {
                  // The code appears as:  <matlab href="file.m"> anything here is ignored </matlab>
                  // We load the contents of the matlab file and show it, with a link.
                  const matlabfilename = domobject.getAttribute('href');
                  const matlabfileurl = "exercises/" + matlabfilename;
                  $.ajax({
                    url: matlabfileurl,
                    dataType: "text",
                    beforeSend: function() { $(domobject).html('Loading file <a target="_blank" href="' + matlabfileurl + '">' + matlabfilename + '</a>...'); },
                    success: function (matlabfilecontents) {
                      // position relative on pre is needed: https://stackoverflow.com/questions/10487292/position-absolute-but-relative-to-parent
                      $newdomobject = $('<pre style="position: relative;" class="featurelesspre"></pre>')
                                        .append('<code class="language-matlab">' + matlabfilecontents + '</code>')
                                        .append('<small style="position: absolute; top: 0; right: 15px;">' +
                                                '<a style="color: white;" target="_blank" href="' + matlabfileurl + '">' + matlabfilename + ' &#11123;</a></small>');
                      hljs.highlightElement($newdomobject.get(0).firstChild);
                      $(domobject).replaceWith($newdomobject);
                    }
                  });
                }
                
              });

              // Format links to exercises, which appear as <a exercise="idoftheexercise">link text</a>.
              // If the linked exercise is in the current list, just jump there.
              // if it's not, then open a new page with just that exercise.
              $('#' + exo + ' ' + 'a[exercise]').each((counter, domobject) => {
                const linkedexercise = domobject.getAttribute('exercise');
                if(exercises.includes(linkedexercise)) {
                  domobject.setAttribute('target', '_self');
                  domobject.setAttribute('href', '#' + linkedexercise);
                }
                else {
                  domobject.setAttribute('target', '_blank');
                  domobject.setAttribute('href', 'exercises.html?list=' + linkedexercise);  // TODO
                }
              });

            }
          });
        });
      }
    });
  </script>

  <script src="mathjax-config.js" defer></script>
  <script type="text/javascript" id="MathJax-script" defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</body>

</html>